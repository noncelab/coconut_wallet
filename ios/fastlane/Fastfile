# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# Fastfile (ios/fastlane/Fastfile)
default_platform(:ios)

require 'yaml'

# â¬‡ï¸ Fastfile íŒŒì¼ ìœ„ì¹˜(__dir__) ê¸°ì¤€ìœ¼ë¡œ ë£¨íŠ¸ ê³„ì‚°
ROOT_DIR = File.expand_path(File.join(__dir__, "..", ".."))
IOS_DIR  = File.join(ROOT_DIR, "ios")
# --- Helpers ----------------------------------------------------------
def read_pubspec_versions
  YAML.load_file(File.join(ROOT_DIR, "pubspec.yaml"))
end
# pubspec.yaml ì˜ˆì‹œ:
# version: 3.3.1+1        # (fallback)
# app_versions:
#   ios_regtest: 3.3.1+1
#   ios_mainnet: 0.4.6+1
def version_tuple_for(platform:, flavor:)
  yml = read_pubspec_versions

  # í‰ë©´ í‚¤ ì¡°í•©: "ios_regtest", "ios_mainnet", "aos_regtest", "aos_mainnet"
  key = "#{platform}_#{flavor}"

  # 1) í”Œë«í¼/í”Œë ˆì´ë²„ë³„ ì§€ì •ê°’ (ì˜ˆ: app_versions.ios_regtest)
  raw = yml.dig("app_versions", key)
  # 2) ì—†ìœ¼ë©´ ê¸€ë¡œë²Œ ê¸°ë³¸ê°’ (ì˜ˆ: version: 3.3.1+1)
  raw ||= yml["version"]
  UI.user_error!("version string not found in pubspec.yaml for key: app_versions.#{key} (and no global 'version')") unless raw

  # "x.y.z+N" íŒŒì‹±
  m = raw.to_s.match(/\A(\d+\.\d+\.\d+)\+(\d+)\z/)
  UI.user_error!("version format must be x.y.z+build, got: #{raw}") unless m

  marketing = m[1]          # "x.y.z"
  build     = m[2].to_i     # N (ì •ìˆ˜)

  return marketing, build
end


# ------------------------------------------
# pubspec.yaml ì—…ë°ì´íŠ¸ (ì„±ê³µ ì‹œ í˜¸ì¶œ)
def update_pubspec_build_number(platform:, flavor:, marketing:, old_build:, new_build:)
  yml_path = File.join(ROOT_DIR, "pubspec.yaml")
  text = File.read(yml_path)

  # platform: "ios" or "aos"
  # flavor: "regtest" or "mainnet"
  key = "#{platform}_#{flavor}:"

  # ì •ê·œì‹ ì˜ˆ: ^\s*ios_regtest:\s*3\.3\.1\+1
  pattern = /^(\s*#{Regexp.escape(key)}\s*)(\d+\.\d+\.\d+)\+(\d+)/

  replaced = text.gsub(pattern) do
    indent_key = Regexp.last_match(1)
    version = Regexp.last_match(2)
    build = Regexp.last_match(3).to_i
    "#{indent_key}#{version}+#{build + 1}"
  end

  if replaced == text
    UI.user_error!("âŒ í•´ë‹¹ í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: #{key}")
  else
    File.write(yml_path, replaced)
    UI.message("âœ… pubspec.yaml updated (#{key.strip}): #{marketing}+#{old_build} â†’ #{marketing}+#{new_build}")
  end
end

# ğŸ‘‰ ë¬¸ìì—´/ë¶ˆë¦¬ì–¸ì„ ì•ˆì „í•˜ê²Œ true/falseë¡œ íŒë³„ (ì˜µì…˜ ì²˜ë¦¬ìš©)
def truthy?(v)
  case v
  when true, "true", "1", 1, "yes", "y", :true then true
  else false
  end
end

# --- Lanes ------------------------------------------------------------
# iOS ë¹Œë“œ ë° TestFlight ì—…ë¡œë“œ
platform :ios do
  desc "Release iOS REGTEST to TestFlight (pubspec.yamlì—ì„œ ë²„ì „ ì½ê¸°, ë¹Œë“œ ì„±ê³µ í›„ ë¹Œë“œ ë²ˆí˜¸ë§Œ +1)"
  lane :release_ios_regtest do |opts|
    opts ||= {}
    flavor    = "regtest"
    platform_ = "ios"

    # ì˜µì…˜/ENV ê¸°ë°˜ ì¤€ë¹„ ë‹¨ê³„ ìŠ¤í‚µ ì œì–´
    skip_prep   = truthy?(opts[:skip_prep]   || ENV["SKIP_PREP"])
    skip_clean  = truthy?(opts[:skip_clean]  || ENV["SKIP_CLEAN"])
    skip_pubget = truthy?(opts[:skip_pubget] || ENV["SKIP_PUBGET"])
    UI.message("skip_prep=#{skip_prep}, skip_clean=#{skip_clean}, skip_pubget=#{skip_pubget}")

    # 1) ë²„ì „ ì½ê¸°
    marketing, old_build = version_tuple_for(platform: platform_, flavor: flavor)
    new_build = old_build + 1
    UI.message("iOS/#{flavor} -> MARKETING_VERSION=#{marketing}, BUILD=#{new_build}")

    # 2) IPA ë¹Œë“œ (Flutter) - ë£¨íŠ¸ì—ì„œ ì‹¤í–‰í•˜ë„ë¡ cd
    begin
      # 1ï¸âƒ£ Flutter ë¹Œë“œ ì‹¤í–‰
      prep_cmds = []
      prep_cmds << "fvm flutter clean"   unless skip_prep || skip_clean
      prep_cmds << "fvm flutter pub get" unless skip_prep || skip_pubget

      sh %Q{
        cd #{ROOT_DIR} &&
        #{prep_cmds.empty? ? "true" : prep_cmds.join(" &&\n        ")} &&
        fvm flutter build ipa \
          --flavor #{flavor} \
          --release \
          --export-method app-store \
          --build-name="#{marketing}" \
          --build-number="#{new_build}"
      }

      # 2ï¸âƒ£ ê°€ì¥ ìµœê·¼ IPA ì—…ë¡œë“œ
      ipa_path = Dir[File.join(ROOT_DIR, "build/ios/ipa/*.ipa")].max_by { |f| File.mtime(f) }
      UI.user_error!("IPA not found!") unless ipa_path

      pilot(
        ipa: ipa_path,
        skip_waiting_for_build_processing: false
      )

      # 3ï¸âƒ£ ë¹Œë“œ ì„±ê³µ ì‹œ pubspec.yaml ì—…ë°ì´íŠ¸
      update_pubspec_build_number(
        platform: platform_,
        flavor: flavor,
        marketing: marketing,
        old_build: old_build,
        new_build: new_build
      )
    rescue => e
      UI.error("âŒ Build failed: #{e.message}")
      UI.important("pubspec.yaml was not updated because build failed.")
      raise
    end
  end

  # ğŸ‘‰ mainnetìš© lane
  desc "Release iOS MAINNET to TestFlight (pubspec.yamlì—ì„œ ë²„ì „ ì½ê¸°, ë¹Œë“œ ì„±ê³µ í›„ ë¹Œë“œ ë²ˆí˜¸ë§Œ +1)"
  lane :release_ios_mainnet do |opts|
    opts ||= {}
    flavor    = "mainnet"
    platform_ = "ios"

    # ì˜µì…˜/ENV ê¸°ë°˜ ì¤€ë¹„ ë‹¨ê³„ ìŠ¤í‚µ ì œì–´
    skip_prep   = truthy?(opts[:skip_prep]   || ENV["SKIP_PREP"])
    skip_clean  = truthy?(opts[:skip_clean]  || ENV["SKIP_CLEAN"])
    skip_pubget = truthy?(opts[:skip_pubget] || ENV["SKIP_PUBGET"])
    UI.message("skip_prep=#{skip_prep}, skip_clean=#{skip_clean}, skip_pubget=#{skip_pubget}")

    marketing, old_build = version_tuple_for(platform: platform_, flavor: flavor)
    new_build = old_build + 1
    UI.message("iOS/#{flavor} -> MARKETING_VERSION=#{marketing}, BUILD=#{new_build}")

    begin
      prep_cmds = []
      prep_cmds << "fvm flutter clean"   unless skip_prep || skip_clean
      prep_cmds << "fvm flutter pub get" unless skip_prep || skip_pubget

      sh %Q{
        cd #{ROOT_DIR} &&
        #{prep_cmds.empty? ? "true" : prep_cmds.join(" &&\n        ")} &&
        fvm flutter build ipa \
          --flavor #{flavor} \
          --release \
          --export-method app-store \
          --build-name="#{marketing}" \
          --build-number="#{new_build}"
      }

      ipa_path = Dir[File.join(ROOT_DIR, "build/ios/ipa/*.ipa")].max_by { |f| File.mtime(f) }
      UI.user_error!("IPA not found!") unless ipa_path

      pilot(
        ipa: ipa_path,
        skip_waiting_for_build_processing: false
      )

      update_pubspec_build_number(
        platform: platform_,
        flavor: flavor,
        marketing: marketing,
        old_build: old_build,
        new_build: new_build
      )
    rescue => e
      UI.error("âŒ Build failed: #{e.message}")
      UI.important("pubspec.yaml was not updated because build failed.")
      raise
    end
  end
end